name: Build OSClock Universal

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-native:
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - os: ubuntu-latest
            osname: linux
            arch: x64
            gcc: gcc
            soext: so
          - os: ubuntu-latest
            osname: linux
            arch: x86
            gcc: "gcc -m32"
            soext: so
          - os: ubuntu-latest
            osname: linux
            arch: arm
            gcc: arm-linux-gnueabihf-gcc
            soext: so
          - os: ubuntu-latest
            osname: linux
            arch: arm64
            gcc: aarch64-linux-gnu-gcc
            soext: so
          # Windows
          - os: windows-latest
            osname: windows
            arch: x64
            vcvars: vcvars64.bat
            soext: dll
          - os: windows-latest
            osname: windows
            arch: x86
            vcvars: vcvars32.bat
            soext: dll
          # macOS
          - os: macos-latest
            osname: macos
            arch: x64
            clang_arch: x86_64
            soext: dylib
          - os: macos-latest
            osname: macos
            arch: arm64
            clang_arch: arm64
            soext: dylib
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 8
        uses: actions/setup-java@v5
        with:
          java-version: 8
          distribution: zulu

      - name: Install cross compilers (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo dpkg --add-architecture i386 || true
          sudo apt-get update
          sudo apt-get install -y gcc-multilib g++-multilib
          sudo apt-get install -y gcc-arm-linux-gnueabihf gcc-aarch64-linux-gnu

      - name: Prepare output dirs (all OS)
        run: |
          mkdir -p build/uc/lang
          mkdir -p build/uc/lang/native/${{ matrix.osname }}-${{ matrix.arch }}

      - name: Compile Java sources
        run: javac -d build -source 1.3 -target 1.1 src/uc/lang/*.java

      - name: Generate JNI headers
        run: javac -h build src/uc/lang/*.java

      # LINUX BUILD
      - name: Build native lib (Linux)
        if: runner.os == 'Linux'
        run: |
          ${{ matrix.gcc }} -shared -fPIC -o build/uc/lang/native/${{ matrix.osname }}-${{ matrix.arch }}/libosclock.${{ matrix.soext }} \
            -I"${JAVA_HOME}/include" -I"${JAVA_HOME}/include/linux" osclock.c || echo "Build fail or skip for ${{ matrix.osname }} ${{ matrix.arch }}"

      # WINDOWS BUILD
      - name: Find MSVC location (Windows)
        if: runner.os == 'Windows'
        id: vswhere
        shell: pwsh
        run: |
          $vsPath = & 'C:\Program Files (x86)\Microsoft Visual Studio\Installer\vswhere.exe' -products * -latest -property installationPath
          echo "VSINSTALL=$vsPath" | Out-File -Append -Encoding utf8 $env:GITHUB_ENV
      - name: Build native lib (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          del osclock.obj >nul 2>nul
          call "%VSINSTALL%\VC\Auxiliary\Build\${{ matrix.vcvars }}"
          cl /LD /I"%JAVA_HOME%\include" /I"%JAVA_HOME%\include\win32" osclock.c /Fe:build\uc\lang\native\${{ matrix.osname }}-${{ matrix.arch }}\osclock.${{ matrix.soext }} || echo "Build fail or skip for ${{ matrix.osname }} ${{ matrix.arch }}"

      # MACOS BUILD
      - name: Build native lib (macOS)
        if: runner.os == 'macOS'
        run: |
          clang -arch ${{ matrix.clang_arch }} -dynamiclib -o build/uc/lang/native/${{ matrix.osname }}-${{ matrix.arch }}/libosclock.${{ matrix.soext }} \
            -I"${JAVA_HOME}/include" -I"${JAVA_HOME}/include/darwin" osclock.c || echo "Build fail or skip for ${{ matrix.osname }} ${{ matrix.arch }}"

      - name: Upload per-arch artifact (class & lib)
        uses: actions/upload-artifact@v4
        with:
          name: artifact-${{ matrix.osname }}-${{ matrix.arch }}
          path: |
            build/uc/lang/*.class
            build/uc/lang/native/${{ matrix.osname }}-${{ matrix.arch }}/*
          if-no-files-found: ignore

  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 8
        uses: actions/setup-java@v5
        with:
          java-version: 8
          distribution: zulu

      - name: Download Android NDK (r26b)
        run: |
          # Use pre-installed NDK if available (on most runners)
          export NDK_ROOT="${ANDROID_NDK_HOME:-/usr/local/lib/android/sdk/ndk-bundle}"
          if [ ! -d "$NDK_ROOT" ]; then
            wget https://dl.google.com/android/repository/android-ndk-r26b-linux.zip
            unzip -q android-ndk-r26b-linux.zip
            NDK_ROOT=$PWD/android-ndk-r26b
          fi
          echo "NDK_ROOT=$NDK_ROOT" >> $GITHUB_ENV

      - name: Prepare output dirs
        run: |
          mkdir -p build/uc/lang
          abis="armeabi-v7a arm64-v8a x86 x86_64"
          for abi in $abis; do
            mkdir -p build/uc/lang/native/android-$abi
          done

      - name: Compile Java sources (Android)
        run: javac -d build -source 1.3 -target 1.1 src/uc/lang/*.java

      - name: Generate JNI headers (Android)
        run: javac -h build src/uc/lang/*.java

      - name: Build JNI libs for all Android ABIs
        env:
          NDK_ROOT: ${{ env.NDK_ROOT }}
        run: |
          abis="armeabi-v7a arm64-v8a x86 x86_64"
          for abi in $abis; do
            case $abi in
              armeabi-v7a)
                tool="$NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang"
                outext="so"
                ;;
              arm64-v8a)
                tool="$NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang"
                outext="so"
                ;;
              x86)
                tool="$NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android21-clang"
                outext="so"
                ;;
              x86_64)
                tool="$NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android21-clang"
                outext="so"
                ;;
            esac
            $tool -shared -fPIC -o build/uc/lang/native/android-$abi/libosclock.$outext \
              -I"${JAVA_HOME}/include" -I"${JAVA_HOME}/include/linux" -I"$NDK_ROOT/sysroot/usr/include" osclock.c \
              || echo "Build fail or skip for android-$abi"
          done

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: artifact-android
          path: |
            build/uc/lang/*.class
            build/uc/lang/native/android-*/libosclock.so
          if-no-files-found: ignore

  combine-universal-jar:
    needs: [build-native, build-android]
    runs-on: ubuntu-latest
    steps:
      - name: Download all arch artifacts
        uses: actions/download-artifact@v4
        with:
          path: extracted

      - name: Prepare content for JAR (merge)
        run: |
          mkdir -p all/uc/lang/native
          # Copy unique class files into all/uc/lang/
          find extracted -name OSClock.class -exec cp -u {} all/uc/lang/ ';'
          find extracted -name 'OSClock$NativeUtils.class' -exec cp -u {} all/uc/lang/ ';'
          # Copy all native directories into all/uc/lang/native/
          for nativedir in $(find extracted -type d -path '*/native/*'); do
            osarch=$(basename "$nativedir")
            mkdir -p all/uc/lang/native/$osarch
            cp -v "$nativedir"/* all/uc/lang/native/$osarch/ || true
          done

      - name: List JAR contents for diagnostics
        run: |
          tree all/

      - name: Create universal JAR
        run: |
          cd all
          jar cf ../osclock-universal.jar uc/

      - uses: actions/upload-artifact@v4
        with:
          name: osclock-universal
          path: osclock-universal.jar